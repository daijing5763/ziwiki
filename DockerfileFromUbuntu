# Build stage
FROM ubuntu_ziwiki AS builder
WORKDIR /app 
COPY . .

RUN export GOPROXY=https://goproxy.cn/ \
  && export PATH="$PATH:$HOME/bin" \
  && bazel build //:gazelle

# Run stage
FROM ubuntu:20.04
WORKDIR /app
COPY --from=builder /app/bazel-bin/ziwiki_/ziwiki .
COPY app.env .
COPY start.sh .
COPY wait-for.sh .
COPY db/migration ./db/migration
RUN chmod +x ./start.sh \
  && chmod +x ./wait-for.sh \
  && apt-get update && apt-get install \
  && apt-get install -y  netcat
EXPOSE 8080
CMD [ "/app/ziwiki" ]
ENTRYPOINT [ "/app/start.sh" ]
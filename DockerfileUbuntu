FROM ubuntu:20.04
WORKDIR /app
COPY . .

RUN  bash builds_ubuntu/deps.sh  \
  && chmod +x builds_ubuntu/bazel-5.3.2-installer-linux-x86_64.sh \
  && builds_ubuntu/bazel-5.3.2-installer-linux-x86_64.sh --user

RUN export PATH="$PATH:$HOME/bin" \
  && export GOPROXY=https://goproxy.cn/ \
  && bazel run //:gazelle \
  && bazel run //:gazelle -- update-repos -from_file=go.mod -to_macro=deps.bzl%go_dependencies \
  && bazel run //:gazelle \
  && bazel build //:all \ 
  && bazel build //srccpp:all 

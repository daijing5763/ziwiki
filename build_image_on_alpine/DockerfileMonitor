# Build stage
FROM gazelle_image_alpine AS builder
WORKDIR /app
COPY . .
RUN export GOPROXY=https://goproxy.cn/ \
  && export PATH="$PATH:$HOME/bin" \
  && bazel run //:gazelle \
  && bazel run //:gazelle -- update-repos -from_file=go.mod -to_macro=deps.bzl%go_dependencies \
  && bazel run //:gazelle \
  && bazel build //:all \ 
  && bazel build //srccpp:all 

# Run stage
FROM alpine:3.16
WORKDIR /app
COPY --from=builder /app/bazel-bin/srccpp/monitor_gen_md .
COPY app.env .
COPY start_monitor.sh .
COPY wait-for.sh .
RUN chmod +x ./start_monitor.sh \
  && chmod +x ./wait-for.sh \
  && apk add g++
CMD [ "/app/monitor_gen_md" ]
ENTRYPOINT [ "/app/start_monitor.sh" ]